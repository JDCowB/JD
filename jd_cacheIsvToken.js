/*
缓存IsvToken

如果你的网络环境不佳，你可以使用此脚本提前缓存，默认缓存到本地，缓存方式基于调用 getToken 模块脚本，更多功能详见如下Readme，支持配置代理和自定义缓存等

7 7 7 7 * jd_cacheIsvToken.js

- ### 配置代理
  - #### 全局代理
    ```bash
    ## 启用代理
    export JD_ISV_GLOBAL_PROXY="true"
    ## 代理组件库相关控制变量
    # 定义 HTTP 代理地址（必填）
    export GLOBAL_AGENT_HTTP_PROXY="" # 例：http://127.0.0.1:8080
    # 过滤不需要代理的地址（必填）
    export GLOBAL_AGENT_NO_PROXY='127.0.0.1,172.17.0.1,*.telegram.org,oapi.dingtalk.com' # 用英文逗号分割多个地址，这里特别注意要把用到的内网ip过滤掉
    ```
    全局代理适用于本仓库绝大多数脚本，更多配置方法详见 [gajus/global-agent](https://github.com/gajus/global-agent)
    需要额外安装代理依赖库才能使用 `npm install -g global-agent`
    > 如果你正在使用 Arcadia 面板则无需重复安装此代理依赖库，并且可以通过命令选项 `--agent` 在任意脚本上便捷的实现全局代理功能，具体详见配置文件和文档
  - #### 获取 `Token` 局部代理
    ```bash
    export JD_ISV_TOKEN_PROXY="" # 代理接口地址
    ```
    目前受限于官方接口策略，同一IP段请求多个账号后会频繁响应 `403`，因此可能需要配合代理使用，使用代理时会自动重试请求至多3次  
    需要额外安装代理依赖库才能使用 `npm install -g hpagent`
    - ##### 通过 API 提取的动态代理
      如果你需要使用的是代理商接口所动态提供的代理地址，那么请定义下方的变量
      ```bash
      export JD_ISV_TOKEN_PROXY_API="" # 代理接口地址，例：http://example.com/api/getProxy?sevret=xxx
      export JD_ISV_TOKEN_PROXY_API_MAX="" # 每个代理地址的使用次数，默认为1次
      ```
      为了避免不必要的浪费建议将接口每次响应的代理地址数量设置为1个，另外建议将接口响应格式设置为单行文本的 `ip:port` 格式，同时也支持 `json` 格式不过仅适配了部分代理商  
      启用此模式后由环境变量 `JD_ISV_TOKEN_PROXY_API` 指定的固定代理地址将会自动被忽略，届时会使用接口响应数据所动态提供的代理地址
- ### 自定义 `Token` 缓存
  - #### 自定义缓存文件路径
    ```bash
    export JD_ISV_TOKEN_CUSTOM_CACHE="" # 绝对路径，建议以 token.json 命名
    ```
    > 此文件默认存储在仓库 `function/cache` 目录下
  - #### 使用 `Redis` 数据库
    ```bash
    export JD_ISV_TOKEN_REDIS_CACHE_URL="" # 数据库地址，例：redis://password@127.0.0.1:6379/0
    export JD_ISV_TOKEN_REDIS_CACHE_KEY="" # 自定义提取或提交的键名规则，详见下方说明
    export JD_ISV_TOKEN_REDIS_CACHE_SUBMIT="" # 是否向数据库提交新的缓存token（true/false），默认是
    ```
    > 需要额外安装依赖库才能使用 `npm install -g redis`，默认从键名为用户名的字符串对象中提取键值，用户名是解码后的  
    > 如果你想自定义键名格式则需要将用户名位置设为 `<pt_pin>` 例如：`isv_token:<pt_pin>`，否则将自动在末尾追加

*/

const $ = new Env('缓存IsvToken')
const jdCookie = require('./jdCookie')
const common = require('./function/jdCommon')
const notify = require('./function/sendJDNotify')
const getToken = require('./function/getToken')

var version_='jsjiami.com.v7';const iliIl1i=Iii1ll1l;(function(iiiliilI,ilIl11iI,IiliillI,Il1lI,iil11l,llIiill,Illli1I1){return iiiliilI=iiiliilI>>0x2,llIiill='hs',Illli1I1='hs',function(liiIIIIl,IiIl11l,iIiI11l,iiIlIlI1,l1Il1IlI){const li1ii1i=Iii1ll1l;iiIlIlI1='tfi',llIiill=iiIlIlI1+llIiill,l1Il1IlI='up',Illli1I1+=l1Il1IlI,llIiill=iIiI11l(llIiill),Illli1I1=iIiI11l(Illli1I1),iIiI11l=0x0;const liII1ili=liiIIIIl();while(!![]&&--Il1lI+IiIl11l){try{iiIlIlI1=parseInt(li1ii1i(0x16a,')ylM'))/0x1+parseInt(li1ii1i(0x13c,'fFSR'))/0x2+parseInt(li1ii1i(0x131,'6sjY'))/0x3*(-parseInt(li1ii1i(0x106,'vZGd'))/0x4)+parseInt(li1ii1i(0x167,'o)F0'))/0x5+parseInt(li1ii1i(0x153,'jHc1'))/0x6+parseInt(li1ii1i(0x11a,'QVel'))/0x7+parseInt(li1ii1i(0x122,'BBf1'))/0x8*(-parseInt(li1ii1i(0x157,'aaYu'))/0x9);}catch(l11lI1Il){iiIlIlI1=iIiI11l;}finally{l1Il1IlI=liII1ili[llIiill]();if(iiiliilI<=Il1lI)iIiI11l?iil11l?iiIlIlI1=l1Il1IlI:iil11l=l1Il1IlI:iIiI11l=l1Il1IlI;else{if(iIiI11l==iil11l['replace'](/[eqQySuHWMPEFItBkdpRYOCT=]/g,'')){if(iiIlIlI1===IiIl11l){liII1ili['un'+llIiill](l1Il1IlI);break;}liII1ili[Illli1I1](l1Il1IlI);}}}}}(IiliillI,ilIl11iI,function(li1Iilli,IIilllii,IIIliI11,l1l1lII,i1liII1,i1IIIIli,i11iIlI){return IIilllii='\x73\x70\x6c\x69\x74',li1Iilli=arguments[0x0],li1Iilli=li1Iilli[IIilllii](''),IIIliI11=`\x72\x65\x76\x65\x72\x73\x65`,li1Iilli=li1Iilli[IIIliI11]('\x76'),l1l1lII=`\x6a\x6f\x69\x6e`,(0x146ca1,li1Iilli[l1l1lII](''));});}(0x32c,0x96bf5,l1iIIIli,0xcd),l1iIIIli)&&(version_=iliIl1i(0x147,'!baM'));function Iii1ll1l(_0x1c8eeb,_0x42c562){const _0x3a8cd0=l1iIIIli();return Iii1ll1l=function(_0x5ef95f,_0x2a4dc0){_0x5ef95f=_0x5ef95f-0xf5;let _0x5b2829=_0x3a8cd0[_0x5ef95f];if(Iii1ll1l['eLkTYJ']===undefined){var _0x718e3e=function(_0x1c4724){const _0x16e8dc='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x419a73='',_0x179166='';for(let _0x2e05b5=0x0,_0xad72fb,_0x520d63,_0x16af1a=0x0;_0x520d63=_0x1c4724['charAt'](_0x16af1a++);~_0x520d63&&(_0xad72fb=_0x2e05b5%0x4?_0xad72fb*0x40+_0x520d63:_0x520d63,_0x2e05b5++%0x4)?_0x419a73+=String['fromCharCode'](0xff&_0xad72fb>>(-0x2*_0x2e05b5&0x6)):0x0){_0x520d63=_0x16e8dc['indexOf'](_0x520d63);}for(let _0xce21c=0x0,_0x3c4452=_0x419a73['length'];_0xce21c<_0x3c4452;_0xce21c++){_0x179166+='%'+('00'+_0x419a73['charCodeAt'](_0xce21c)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x179166);};const _0x59cb0b=function(_0x20f631,_0x12556e){let _0xd74145=[],_0x9181b9=0x0,_0x5af259,_0x55ddfe='';_0x20f631=_0x718e3e(_0x20f631);let _0x5aeae2;for(_0x5aeae2=0x0;_0x5aeae2<0x100;_0x5aeae2++){_0xd74145[_0x5aeae2]=_0x5aeae2;}for(_0x5aeae2=0x0;_0x5aeae2<0x100;_0x5aeae2++){_0x9181b9=(_0x9181b9+_0xd74145[_0x5aeae2]+_0x12556e['charCodeAt'](_0x5aeae2%_0x12556e['length']))%0x100,_0x5af259=_0xd74145[_0x5aeae2],_0xd74145[_0x5aeae2]=_0xd74145[_0x9181b9],_0xd74145[_0x9181b9]=_0x5af259;}_0x5aeae2=0x0,_0x9181b9=0x0;for(let _0x4e4553=0x0;_0x4e4553<_0x20f631['length'];_0x4e4553++){_0x5aeae2=(_0x5aeae2+0x1)%0x100,_0x9181b9=(_0x9181b9+_0xd74145[_0x5aeae2])%0x100,_0x5af259=_0xd74145[_0x5aeae2],_0xd74145[_0x5aeae2]=_0xd74145[_0x9181b9],_0xd74145[_0x9181b9]=_0x5af259,_0x55ddfe+=String['fromCharCode'](_0x20f631['charCodeAt'](_0x4e4553)^_0xd74145[(_0xd74145[_0x5aeae2]+_0xd74145[_0x9181b9])%0x100]);}return _0x55ddfe;};Iii1ll1l['DheAaH']=_0x59cb0b,_0x1c8eeb=arguments,Iii1ll1l['eLkTYJ']=!![];}const _0x3498cb=_0x3a8cd0[0x0],_0x22d845=_0x5ef95f+_0x3498cb,_0xa73317=_0x1c8eeb[_0x22d845];return!_0xa73317?(Iii1ll1l['GtSvMQ']===undefined&&(Iii1ll1l['GtSvMQ']=!![]),_0x5b2829=Iii1ll1l['DheAaH'](_0x5b2829,_0x2a4dc0),_0x1c8eeb[_0x22d845]=_0x5b2829):_0x5b2829=_0xa73317,_0x5b2829;},Iii1ll1l(_0x1c8eeb,_0x42c562);}let cookie='',originCookie='';const cookiesArr=Object[iliIl1i(0x151,'&*$d')](jdCookie)[iliIl1i(0x130,'&*$d')](li1iIIl=>jdCookie[li1iIIl])[iliIl1i(0x13f,'uf3Q')](I1I1li1l=>I1I1li1l);!cookiesArr[0x0]&&($[iliIl1i(0x107,'v$*V')]($[iliIl1i(0x15b,'o)F0')],iliIl1i(0x152,'&*$d')),process[iliIl1i(0x118,'MuFK')](0x1));!(async()=>{const i1IlII1l=iliIl1i,lIl1I1ii={'GvAbF':i1IlII1l(0x12a,'!baM'),'kijSw':i1IlII1l(0x109,'v$*V'),'zEsRC':i1IlII1l(0x12e,'1zNI'),'FYLRe':i1IlII1l(0x15c,'Yy%r'),'BpfAu':function(lillII1l,iiIi1iI){return lillII1l<iiIi1iI;},'XyIZu':function(lIiI11I,I11Iilii){return lIiI11I+I11Iilii;},'Hffjn':function(II1I1ilI,iilI1I11){return II1I1ilI(iilI1I11);},'wIxaF':i1IlII1l(0x113,'#XG1'),'PdgqI':function(IIl11Ili){return IIl11Ili();},'DZGbm':function(iIiiil1,lIlilIiI){return iIiiil1===lIlilIiI;},'JoEVC':i1IlII1l(0xf5,'zO!7'),'suouf':i1IlII1l(0x138,'Jc8t')};$[i1IlII1l(0x102,'@A3W')]=[lIl1I1ii[i1IlII1l(0xfb,'jHc1')],lIl1I1ii[i1IlII1l(0xff,'O]p!')],lIl1I1ii[i1IlII1l(0x14a,'jGDv')]],notify[i1IlII1l(0x110,'VrFp')]({'title':$[i1IlII1l(0x148,'V6zn')]});for(let I1I1IilI=0x0;lIl1I1ii[i1IlII1l(0x11f,'3sOZ')](I1I1IilI,cookiesArr[i1IlII1l(0xfa,'mK6o')]);I1I1IilI++){$[i1IlII1l(0x10f,'QKeV')]=lIl1I1ii[i1IlII1l(0x11c,'@A3W')](I1I1IilI,0x1),cookie=cookiesArr[I1I1IilI],originCookie=cookiesArr[I1I1IilI],common[i1IlII1l(0x115,'#XG1')](originCookie),$[i1IlII1l(0xf8,'Yy%r')]=lIl1I1ii[i1IlII1l(0x114,'z[40')](decodeURIComponent,common[i1IlII1l(0x103,'%Z03')](cookie,lIl1I1ii[i1IlII1l(0x13d,'1zNI')])),$[i1IlII1l(0xfe,'BBf1')]=notify[i1IlII1l(0x11e,'vhwv')]($[i1IlII1l(0x15a,'6sjY')],$[i1IlII1l(0x142,'%Z03')]),$[i1IlII1l(0x10d,'o)F0')]='',console[i1IlII1l(0x111,'%Z03')](i1IlII1l(0x158,'!baM')+$[i1IlII1l(0x124,'#XG1')]+'】'+($[i1IlII1l(0x15e,')ylM')]||$[i1IlII1l(0x159,'z[40')])+i1IlII1l(0x12f,'uf3Q')),await lIl1I1ii[i1IlII1l(0xf7,'fFSR')](Main),common[i1IlII1l(0x16b,'vhwv')]();if($[i1IlII1l(0x14b,'QVel')]||$[i1IlII1l(0xfc,'RU&q')])break;}const I111ll11=notify[i1IlII1l(0x16c,'^#Xs')]();I111ll11&&(lIl1I1ii[i1IlII1l(0x134,'QVel')](lIl1I1ii[i1IlII1l(0x104,'MBUC')],lIl1I1ii[i1IlII1l(0x112,'zO!7')])?console[i1IlII1l(0x15d,'Bsj!')](i1IlII1l(0x119,'CwBY')+I111ll11[i1IlII1l(0x12b,'VrFp')](/：/g,lIl1I1ii[i1IlII1l(0x150,'O]p!')])):(l1iiliiI[i1IlII1l(0x123,'%WYr')](i1111i1[i1IlII1l(0x149,'aaYu')],lIl1I1ii[i1IlII1l(0x121,'1zNI')]),IiIlII11[i1IlII1l(0x10c,'@(ve')](0x1)));})()[iliIl1i(0x164,'DxyC')](lIi1I1ii=>$[iliIl1i(0x162,'%Z03')](lIi1I1ii))[iliIl1i(0x101,'o)F0')](()=>$[iliIl1i(0x165,'CwBY')]());function l1iIIIli(){const IllIIli=(function(){return[...[version_,'kBjtBIsjPiYaSmQki.WcMFoHmpd.Rvyu7CEeTOeq==','a8oQFISpwZldIsmqWOtdQJe1','WPpWLRkwWQZOV7ROOl7NU67MNPddQW','mdHG','W6hdTmoMWOKGW786','FNHiaqNdGghLVkJLP5ZJGPdKU4NKUlJOT7NLJOm','WQ3cK2WsraHHta','AYumC1C','jSo+WQy8','s8k4WQ7cHwtdVh7dLX5QqmomjmkNkXK5W5veWOS0W4VcU8k+W6JdL0urdt8','W7D3WRm','rHmVW6DcxXJcNW','WPH4Ea','us3dLmkoW5zXW6zeW4LrWOK','imozbW','s0qmbcCf','eJSA','W4WjW4jLW5O','jhVcMdu','WOlcH1tcMx0','E8kOW7nUW7xdGCocFG/dKc/dIYK','asaowa','vIVdMmkmW50KWQjWW4XyWQhdUg8','hKH4WRW/dIxcSLRdVfCO','D8omW44utGpdOSk2WRm2Bq','W5/dJ1xdOmohWQBdI8kvpCoT','sSkeBJxcTa','th1LWRZcKG','gCkyW6ypWOG','DSk/WR/cH1NcPZZcNq','lSkKW6GYWPa','WPHYCCorW5Dv','W4jwDx7dLq','W4X8AxWNWQi','WOqaWRSecG','WQKyW5XFpXLz','F8oVemkaWQS','WQ3dNSoBWPu5','lSo2WQu4WQdcN8kl','iYn0zq'],...(function(){return[...['qe4FaJOynHyng8oZWQn6ra','l3pcPCoTWQC','WRNINRPv','W55iECoCWOVdLq5zW6JdMmkL','Cez8','WPvHW6HBW6KtW73dNuz5zmkv','DufVFmkoWR99dmkyWONdL8oIWPBdKSkpEhXEA1NdR8oaFKzvW53cMq7cJHG','W5XnC14','WP3dISknWRFdIa','W4JdShuE','jSo2WQGYWOlcKSkFwG','uSk5vs/cS1uI','wmk0k35d','W7RcN8k1mSk/ba','s0qm','ASkZybxcKq','WORdPSk7WOVdSdy','WRdcHM8kza','WONdT8kqWRJdTJFdSGZdMW','rH0KW5zJ','WPVcUIHAWQ9UcmkLW6ZcTrPU','W7XEhmo4','sVcAKjvW6lYz6kcB57Qx5P26iq','kmkqWQhdH8obxYZdP8ociCo9WPe','pSkAW5CfW40','dIHrtmkl','WRtdRNy','yCoqW5GqtIu','W5xdTJNdKSoJ','WPBdVCkd','CLJdGs1V','W7znWP4CAK8jiSkgWRWDwCoUsa','WRxdSNy','WPpdVmkaWP7dOq','WOnBWO3dS3nzWQ0','WPVcUc1CWQPQBmk5W7FcGbDmW5q','v8kZnW','DSonW77cK8kgaa','pcjYF8kFfSkxadv6WORdVSkvtq','44gK5O6c56wy44c66k+u5yAI6i+85y++vmoVcK/cTHe','W6VcLCkRomk3ahO'],...(function(){return['W7nCiCoyzG','4P6MwEIfL+AFHEI9QEIJVUMaVEwiNos4H+MwIEISPCop','xvRdTd9AB8ooW6nSif3cOJFdSKJdTuXYW7BcQGVcG8k9uMNdHW','WOWpaCo1kSopW7m','WOGyWQm','n3WUw3/dMCkFCa','WQGsW4G','nYHWt8ki','xSoYW5FcLSkF','WRxdPgjFvI3dVa','WOddI0vNFq','WPxcHxOtAW5P','WPtINzrT','c8osd17dPq','W4zpuKhdMa','WOSprmohoSoUW6FdGa','EmoeWRflW7tdV8kEW4OpW6mHWOOm','qMFdUc5V','Bvmgdt8','W4bmr8kRzCkx','W6NcUsezaNpcR8kMdSkUeCo0BW','cCoDWOqpWO4','CLGomXSwmbO','sCk+W6OCW7jhW4u','4P6MwEE9NUwUSEwMIoI2LW','tYiLW4bD','57Yr5A+65AYX5Q6K','hIeiqKlcHYigDmoVcaRcQum','c8kymSk5','WRBdLSoGWPK','WQHNWRldKNC','DCoDW6tcSSkEcqa','W4BcQsnIA8kS','W4BcNGrOBW','W43cIGD/tq','xComW7/cHmkI','DSoFdmkNWO4','WO4CWQOU','44o15O6P56EP44gm6k6l5yw/6i2M5y+wsYvjWPnIyW','WP8plHVcLmkHWQBdRGdcRYniDW'];}())];}())];}());l1iIIIli=function(){return IllIIli;};return l1iIIIli();};async function Main(){const l1IlIIli=iliIl1i,iI1Iilli={'gXiLQ':l1IlIIli(0x146,'vhwv'),'ABOVB':l1IlIIli(0x105,'MuFK'),'NgVlr':function(IliIi,ii11iii,il1lIi1){return IliIi(ii11iii,il1lIi1);},'opMlz':function(IllilIl,ili1Ii){return IllilIl*ili1Ii;},'XJTKJ':function(llll11I1,IIl1i1li){return llll11I1!==IIl1i1li;},'JxmLj':l1IlIIli(0x100,'aaYu'),'rVInk':l1IlIIli(0x116,')ylM'),'GdopP':l1IlIIli(0x144,'vZGd'),'jzTTL':function(iliIliiI,ii1lI1ii){return iliIliiI===ii1lI1ii;},'ayhYv':l1IlIIli(0x14e,'Jc8t')};try{const IliII11i=await iI1Iilli[l1IlIIli(0x11b,'Sqd1')](getToken,originCookie,$[l1IlIIli(0x10a,'jHc1')][Math[l1IlIIli(0xf6,'zCuw')](iI1Iilli[l1IlIIli(0x13a,'jHc1')](Math[l1IlIIli(0x14c,'Jc8t')](),$[l1IlIIli(0x168,'!baM')][l1IlIIli(0x128,'QVel')]))]);IliII11i?(console[l1IlIIli(0x132,'BBf1')](iI1Iilli[l1IlIIli(0x166,'dZlY')]),$[l1IlIIli(0x125,'jGDv')][l1IlIIli(0x163,'!baM')](iI1Iilli[l1IlIIli(0xf9,'fFSR')])):iI1Iilli[l1IlIIli(0x136,'%WYr')](iI1Iilli[l1IlIIli(0x13e,'%Z03')],iI1Iilli[l1IlIIli(0x14d,'Jc8t')])?(console[l1IlIIli(0x161,'x^[x')](iI1Iilli[l1IlIIli(0x14f,'QVel')]),$[l1IlIIli(0x137,'z[40')][l1IlIIli(0x156,'@A3W')](iI1Iilli[l1IlIIli(0x139,'x^[x')])):(IiilllI1[l1IlIIli(0x11d,'%WYr')](iI1Iilli[l1IlIIli(0x145,')ylM')]),I1Ii1111[l1IlIIli(0x135,'%WYr')][l1IlIIli(0x127,'QKeV')](iI1Iilli[l1IlIIli(0x10b,'#XG1')]));}catch(iIiil1ii){iI1Iilli[l1IlIIli(0x12c,'MuFK')](iI1Iilli[l1IlIIli(0x133,'@A3W')],iI1Iilli[l1IlIIli(0xfd,'&*$d')])?console[l1IlIIli(0x15f,'mK6o')](l1IlIIli(0x12d,'vZGd')+iIiil1ii):llIlIlll[l1IlIIli(0x120,'#XG1')](l1IlIIli(0x155,'MuFK')+ii1IlIii[l1IlIIli(0x10e,'zO!7')](/：/g,iI1Iilli[l1IlIIli(0x141,'o)F0')]));}}var version_ = 'jsjiami.com.v7';

// prettier-ignore
function Env(t,e){"undefined"!=typeof process&&JSON.stringify(process.env).indexOf("GITHUB")>-1&&process.exit(0);class s{constructor(t){this.env=t}send(t,e="GET"){t="string"==typeof t?{url:t}:t;let s=this.get;return"POST"===e&&(s=this.post),new Promise((e,i)=>{s.call(this,t,(t,s,r)=>{t?i(t):e(s)})})}get(t){return this.send.call(this.env,t)}post(t){return this.send.call(this.env,t,"POST")}}return new class{constructor(t,e){this.name=t,this.http=new s(this),this.data=null,this.dataFile="box.dat",this.logs=[],this.isMute=!1,this.isNeedRewrite=!1,this.logSeparator="\n",this.startTime=(new Date).getTime(),Object.assign(this,e),this.log("",`🔔${this.name}, 开始!`)}isNode(){return"undefined"!=typeof module&&!!module.exports}isQuanX(){return"undefined"!=typeof $task}isSurge(){return"undefined"!=typeof $httpClient&&"undefined"==typeof $loon}isLoon(){return"undefined"!=typeof $loon}toObj(t,e=null){try{return JSON.parse(t)}catch{return e}}toStr(t,e=null){try{return JSON.stringify(t)}catch{return e}}getjson(t,e){let s=e;const i=this.getdata(t);if(i)try{s=JSON.parse(this.getdata(t))}catch{}return s}setjson(t,e){try{return this.setdata(JSON.stringify(t),e)}catch{return!1}}getScript(t){return new Promise(e=>{this.get({url:t},(t,s,i)=>e(i))})}runScript(t,e){return new Promise(s=>{let i=this.getdata("@chavy_boxjs_userCfgs.httpapi");i=i?i.replace(/\n/g,"").trim():i;let r=this.getdata("@chavy_boxjs_userCfgs.httpapi_timeout");r=r?1*r:20,r=e&&e.timeout?e.timeout:r;const[o,h]=i.split("@"),n={url:`http://${h}/v1/scripting/evaluate`,body:{script_text:t,mock_type:"cron",timeout:r},headers:{"X-Key":o,Accept:"*/*"}};this.post(n,(t,e,i)=>s(i))}).catch(t=>this.logErr(t))}loaddata(){if(!this.isNode())return{};{this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),i=!s&&this.fs.existsSync(e);if(!s&&!i)return{};{const i=s?t:e;try{return JSON.parse(this.fs.readFileSync(i))}catch(t){return{}}}}}writedata(){if(this.isNode()){this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),i=!s&&this.fs.existsSync(e),r=JSON.stringify(this.data);s?this.fs.writeFileSync(t,r):i?this.fs.writeFileSync(e,r):this.fs.writeFileSync(t,r)}}lodash_get(t,e,s){const i=e.replace(/\[(\d+)\]/g,".$1").split(".");let r=t;for(const t of i)if(r=Object(r)[t],void 0===r)return s;return r}lodash_set(t,e,s){return Object(t)!==t?t:(Array.isArray(e)||(e=e.toString().match(/[^.[\]]+/g)||[]),e.slice(0,-1).reduce((t,s,i)=>Object(t[s])===t[s]?t[s]:t[s]=Math.abs(e[i+1])>>0==+e[i+1]?[]:{},t)[e[e.length-1]]=s,t)}getdata(t){let e=this.getval(t);if(/^@/.test(t)){const[,s,i]=/^@(.*?)\.(.*?)$/.exec(t),r=s?this.getval(s):"";if(r)try{const t=JSON.parse(r);e=t?this.lodash_get(t,i,""):e}catch(t){e=""}}return e}setdata(t,e){let s=!1;if(/^@/.test(e)){const[,i,r]=/^@(.*?)\.(.*?)$/.exec(e),o=this.getval(i),h=i?"null"===o?null:o||"{}":"{}";try{const e=JSON.parse(h);this.lodash_set(e,r,t),s=this.setval(JSON.stringify(e),i)}catch(e){const o={};this.lodash_set(o,r,t),s=this.setval(JSON.stringify(o),i)}}else s=this.setval(t,e);return s}getval(t){return this.isSurge()||this.isLoon()?$persistentStore.read(t):this.isQuanX()?$prefs.valueForKey(t):this.isNode()?(this.data=this.loaddata(),this.data[t]):this.data&&this.data[t]||null}setval(t,e){return this.isSurge()||this.isLoon()?$persistentStore.write(t,e):this.isQuanX()?$prefs.setValueForKey(t,e):this.isNode()?(this.data=this.loaddata(),this.data[e]=t,this.writedata(),!0):this.data&&this.data[e]||null}initGotEnv(t){this.got=this.got?this.got:require("got"),this.cktough=this.cktough?this.cktough:require("tough-cookie"),this.ckjar=this.ckjar?this.ckjar:new this.cktough.CookieJar,t&&(t.headers=t.headers?t.headers:{},void 0===t.headers.Cookie&&void 0===t.cookieJar&&(t.cookieJar=this.ckjar))}get(t,e=(()=>{})){t.headers&&(delete t.headers["Content-Type"],delete t.headers["Content-Length"]),this.isSurge()||this.isLoon()?(this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient.get(t,(t,s,i)=>{!t&&s&&(s.body=i,s.statusCode=s.status),e(t,s,i)})):this.isQuanX()?(this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>e(t))):this.isNode()&&(this.initGotEnv(t),this.got(t).on("redirect",(t,e)=>{try{if(t.headers["set-cookie"]){const s=t.headers["set-cookie"].map(this.cktough.Cookie.parse).toString();s&&this.ckjar.setCookieSync(s,null),e.cookieJar=this.ckjar}}catch(t){this.logErr(t)}}).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>{const{message:s,response:i}=t;e(s,i,i&&i.body)}))}post(t,e=(()=>{})){if(t.body&&t.headers&&!t.headers["Content-Type"]&&(t.headers["Content-Type"]="application/x-www-form-urlencoded"),t.headers&&delete t.headers["Content-Length"],this.isSurge()||this.isLoon())this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient.post(t,(t,s,i)=>{!t&&s&&(s.body=i,s.statusCode=s.status),e(t,s,i)});else if(this.isQuanX())t.method="POST",this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>e(t));else if(this.isNode()){this.initGotEnv(t);const{url:s,...i}=t;this.got.post(s,i).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>{const{message:s,response:i}=t;e(s,i,i&&i.body)})}}time(t,e=null){const s=e?new Date(e):new Date;let i={"M+":s.getMonth()+1,"d+":s.getDate(),"H+":s.getHours(),"m+":s.getMinutes(),"s+":s.getSeconds(),"q+":Math.floor((s.getMonth()+3)/3),S:s.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(s.getFullYear()+"").substr(4-RegExp.$1.length)));for(let e in i)new RegExp("("+e+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?i[e]:("00"+i[e]).substr((""+i[e]).length)));return t}msg(e=t,s="",i="",r){const o=t=>{if(!t)return t;if("string"==typeof t)return this.isLoon()?t:this.isQuanX()?{"open-url":t}:this.isSurge()?{url:t}:void 0;if("object"==typeof t){if(this.isLoon()){let e=t.openUrl||t.url||t["open-url"],s=t.mediaUrl||t["media-url"];return{openUrl:e,mediaUrl:s}}if(this.isQuanX()){let e=t["open-url"]||t.url||t.openUrl,s=t["media-url"]||t.mediaUrl;return{"open-url":e,"media-url":s}}if(this.isSurge()){let e=t.url||t.openUrl||t["open-url"];return{url:e}}}};if(this.isMute||(this.isSurge()||this.isLoon()?$notification.post(e,s,i,o(r)):this.isQuanX()&&$notify(e,s,i,o(r))),!this.isMuteLog){let t=["","==============📣系统通知📣=============="];t.push(e),s&&t.push(s),i&&t.push(i),console.log(t.join("\n")),this.logs=this.logs.concat(t)}}log(...t){t.length>0&&(this.logs=[...this.logs,...t]),console.log(t.join(this.logSeparator))}logErr(t,e){const s=!this.isSurge()&&!this.isQuanX()&&!this.isLoon();s?this.log("",`❗️${this.name}, 错误!`,t.stack):this.log("",`❗️${this.name}, 错误!`,t)}wait(t){return new Promise(e=>setTimeout(e,t))}done(t={}){const e=(new Date).getTime(),s=(e-this.startTime)/1e3;this.log("",`🔔${this.name}, 结束! 🕛 ${s} 秒`),this.log(),(this.isSurge()||this.isQuanX()||this.isLoon())&&$done(t)}}(t,e)}
